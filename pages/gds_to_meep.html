
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>GDS to Meep &#8212; CamachoLab Photonics Bootcamp</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://byucamacholab.github.io/Photonics-Bootcamp/pages/gds_to_meep.html" />
    <link rel="shortcut icon" href="../_static/favicon-laser.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Front Matter
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="credits.html">
   Credits
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Familiar with Code
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="open_source.html">
   Open Source Software
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Passive Device Design and Simulation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="directional_couplers.html">
   Directional Couplers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="mmis.html">
   Multimode Interferometers (MMIs)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/BYUCamachoLab/sky130ph">
   Repository
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/BYUCamachoLab/sky130ph/docs">
   PDK Documentation
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/pages/gds_to_meep.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#finding-s-parameters-through-gmeep">
   Finding S-parameters through gmeep
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adjoint-solver-in-gdsfactory">
   Adjoint solver in GDSFactory
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>GDS to Meep</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#finding-s-parameters-through-gmeep">
   Finding S-parameters through gmeep
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adjoint-solver-in-gdsfactory">
   Adjoint solver in GDSFactory
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="gds-to-meep">
<h1>GDS to Meep<a class="headerlink" href="#gds-to-meep" title="Permalink to this headline">#</a></h1>
<p><a class="reference external" href="https://github.com/gdsfactory/gdsfactory/tree/main/gdsfactory/simulation/gmeep">Gmeep Github</a></p>
<p>It is often useful to simulate photonic devices before manufacturing them so that you have some idea of their performance. GDSFactory has a Meep plugin, Gmeep, that can be used to simulate devices using the finite-difference time-domain algorithm (FDTD).</p>
<p>There are several functions within Gmeep that can be used to take a component and turn it into a Meep geometry or simulation. This means that you can take any component, either from GDSFactory or from a GDS file (see the “component_from_gds” notebook), and easily turn it into a Meep geometry. The two most general functions are <code class="docutils literal notranslate"><span class="pre">get_simulation</span></code> and <code class="docutils literal notranslate"><span class="pre">get_meep_geometry_from_component</span></code> (contained within <code class="docutils literal notranslate"><span class="pre">gmeep.get_simulation.py</span></code>). There are other more specific functions to get simulations for a grating coupler with a fiber connected to it, as well as for a far-field simulation for a grating coupler. However, the first two will suffice in this tutorial. Below is some example code showing the use of the functions.</p>
<ul class="simple">
<li><p>pitfalls to avoid</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Code showing examples with a 2x2 MMI for the functions in get_simulation</span>

<span class="kn">import</span> <span class="nn">gdsfactory</span> <span class="k">as</span> <span class="nn">gf</span>
<span class="kn">import</span> <span class="nn">meep</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">gdsfactory.simulation.gmeep.get_simulation</span> <span class="kn">import</span> <span class="n">get_simulation</span><span class="p">,</span> <span class="n">get_meep_geometry_from_component</span>

<span class="c1"># Load in the 2x2 MMI from GDSFactory and show layout</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">mmi2x2</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="c1"># get_meep_geometry_from_component implementation example</span>
<span class="n">get_meep_geometry_from_component</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="c1"># get_simulation implementation example</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">get_simulation</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
    <span class="n">resolution</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">tpml</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">port_source_offset</span><span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="n">port_monitor_offset</span><span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span>
    <span class="n">distance_source_to_monitors</span><span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sim</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]</span>
<span class="n">sim</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cell_size</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">sim</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cell_size</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">sim</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot2D</span><span class="p">()</span>
<span class="c1"># sim[&#39;sim&#39;].run(until=200)</span>

<span class="kn">from</span> <span class="nn">gdsfactory.simulation.gmeep</span> <span class="kn">import</span> <span class="n">write_sparameters_meep</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/gds_to_meep_1_0.png" src="../_images/gds_to_meep_1_0.png" />
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">37</span><span class="p">],</span> <span class="n">line</span> <span class="mi">16</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">SiO2</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Medium</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mf">1.45</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="c1"># get_simulation implementation example</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="n">sim</span> <span class="o">=</span> <span class="n">get_simulation</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>     <span class="n">resolution</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span>     <span class="n">clad_material</span><span class="o">=</span> <span class="n">SiO2</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span>     <span class="n">tpml</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span>     <span class="n">port_source_offset</span><span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span>     <span class="n">port_monitor_offset</span><span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span>     <span class="n">distance_source_to_monitors</span><span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;sources&#39;</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cell_size</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">8</span>

<span class="nn">File ~/miniconda3/envs/pmp/lib/python3.11/site-packages/gdsfactory/simulation/gmeep/get_simulation.py:255,</span> in <span class="ni">get_simulation</span><span class="nt">(component, resolution, extend_ports_length, layer_stack, zmargin_top, zmargin_bot, tpml, clad_material, is_3d, wavelength_start, wavelength_stop, wavelength_points, dfcen, port_source_name, port_margin, distance_source_to_monitors, port_source_offset, port_monitor_offset, dispersive, material_name_to_meep, **settings)</span>
<span class="g g-Whitespace">    </span><span class="mi">232</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">233</span>         <span class="sa">f</span><span class="s2">&quot;Port source </span><span class="si">{</span><span class="n">port_source_name</span><span class="si">!r}</span><span class="s2"> orientation </span><span class="si">{</span><span class="n">port</span><span class="o">.</span><span class="n">orientation</span><span class="si">}</span><span class="s2"> &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">234</span>         <span class="s2">&quot;not 0, 90, 180, 270 degrees&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">235</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span> <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span>
<span class="g g-Whitespace">    </span><span class="mi">238</span>     <span class="n">mp</span><span class="o">.</span><span class="n">EigenModeSource</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>         <span class="n">src</span><span class="o">=</span><span class="n">mp</span><span class="o">.</span><span class="n">GaussianSource</span><span class="p">(</span><span class="n">fcen</span><span class="p">,</span> <span class="n">fwidth</span><span class="o">=</span><span class="n">frequency_width</span><span class="p">),</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">247</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span> <span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">250</span> <span class="n">sim</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>     <span class="n">cell_size</span><span class="o">=</span><span class="n">cell_size</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>     <span class="n">boundary_layers</span><span class="o">=</span><span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">PML</span><span class="p">(</span><span class="n">tpml</span><span class="p">)],</span>
<span class="g g-Whitespace">    </span><span class="mi">253</span>     <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">254</span>     <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">255</span>     <span class="n">default_material</span><span class="o">=</span><span class="n">get_material</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">256</span>         <span class="n">name</span><span class="o">=</span><span class="n">clad_material</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">257</span>         <span class="n">material_name_to_meep</span><span class="o">=</span><span class="n">material_name_to_meep</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">258</span>         <span class="n">wavelength</span><span class="o">=</span><span class="n">wavelength</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">259</span>     <span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span>     <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span>     <span class="o">**</span><span class="n">settings</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">262</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span> <span class="c1"># Add port monitors dict</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span> <span class="n">monitors</span> <span class="o">=</span> <span class="p">{}</span>

<span class="nn">File ~/miniconda3/envs/pmp/lib/python3.11/site-packages/gdsfactory/simulation/gmeep/get_material.py:41,</span> in <span class="ni">get_material</span><span class="nt">(name, wavelength, dispersive, material_name_to_meep)</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span> <span class="n">material_name_to_meep</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">material_name_to_meep_new</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span> <span class="n">materials</span> <span class="o">=</span> <span class="p">[</span><span class="n">material</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">material</span> <span class="ow">in</span> <span class="n">MATERIALS</span><span class="p">]</span>
<span class="ne">---&gt; </span><span class="mi">41</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span> <span class="k">if</span> <span class="n">dispersive</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span>     <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">material_name_to_meep</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

<span class="ne">AttributeError</span>: &#39;Medium&#39; object has no attribute &#39;lower&#39;
</pre></div>
</div>
</div>
</div>
<section id="finding-s-parameters-through-gmeep">
<h2>Finding S-parameters through gmeep<a class="headerlink" href="#finding-s-parameters-through-gmeep" title="Permalink to this headline">#</a></h2>
<p>In addition to creating general simulations in Meep, there are several functions in GDSFactory that allow you to find the S-parameters (scattering parameters) of a given component. S-parameters are useful as they tell you how much light is coming in and out of each of the component’s port. The most general function for this purpose in Gmeep is <code class="docutils literal notranslate"><span class="pre">write_sparameters_meep</span></code>.</p>
<p>To use this function, you specify a GDSFactory component, the frequencies you want to test it at, if you would like the simulation to be in 3D, and the margins the simulation needs to take into account. Another useful kwarg for this function is “run”. By setting this to <code class="docutils literal notranslate"><span class="pre">False</span></code>, the function plots the simulation geometry instead of running it. So, you can check that the geometry is correct before you waste time simulating it.This is especially important when running the simulation in 3D, as sometimes your geometry may be converted incorrectly from 2D.This is not a comprehensive list of the arguments and is only intended to give a general idea of how the function is used.</p>
<p>The function returns a dictionary of s-parameters. The keys take the form of <code class="docutils literal notranslate"><span class="pre">&quot;o1&#64;0,o2&#64;0&quot;</span></code>, where the first part of the key refers to what port the light is coming from and the second refers to where it is going. For however many ports you have in your component, there will be a key corresponding to the s-parameter from that port to every other port.</p>
<p>Since the relationship between some ports can be the same (i.e. the component may be symmetric), port symmetries can be specified as a keyword argument (kwarg) (<code class="docutils literal notranslate"><span class="pre">port_symmetries</span></code>). This argument takes a dictionary where you specify one s-parameter as the key, and assign as its values the other s-parameters that correspond to it. For example, if you had a 1x2 splitter, where the 2 output ports were symmetric and labeled ports 2 and 3, then you could assign:</p>
<p><code class="docutils literal notranslate"><span class="pre">port_symmetries</span> <span class="pre">=</span> <span class="pre">{&quot;o2&#64;0,o1&#64;0&quot;:</span> <span class="pre">[&quot;o3&#64;0,o1&#64;0&quot;]}</span></code></p>
<p>so that the s-parameter for port 2 to 1 will be computed, but the one for port 3 to 1 will not be and will be written with the s-parameter for port 2 to 1. Thus, you save on computation time.</p>
<p>In addition to this general function, Gmeep also has two functions that can be used to write the s-parameters using parallel processing. These are <code class="docutils literal notranslate"><span class="pre">write_sparamters_meep_mpi</span></code> and <code class="docutils literal notranslate"><span class="pre">write_sparameters_meep_batch</span></code>. <code class="docutils literal notranslate"><span class="pre">write_sparamters_meep_mpi</span></code> has you specify how many cores you want to use as a kwarg. <code class="docutils literal notranslate"><span class="pre">write_sparameters_meep_batch</span></code> takes it a step further and runs multiple simulations in parallel, instead of just one. So, you must specify the number of cores per run in addition to the total number of cores to use.</p>
<p><code class="docutils literal notranslate"><span class="pre">write_sparameters_grating</span></code> is a more specific instance that can be used to find the s-parameters for a grating coupler with an attached fiber. To plot the set up of this, you can pass in the argument <code class="docutils literal notranslate"><span class="pre">plot=True</span></code>. There is also the option of writing the s-parameters for a grating coupler in parallel or in batches, with <code class="docutils literal notranslate"><span class="pre">write_sparameters_grating_mpi</span></code> and <code class="docutils literal notranslate"><span class="pre">write_sparameters_grating_batch</span></code>. Like the general s-parameter functions above, more kwargs are necessary to adequately define them.</p>
</section>
<section id="adjoint-solver-in-gdsfactory">
<h2>Adjoint solver in GDSFactory<a class="headerlink" href="#adjoint-solver-in-gdsfactory" title="Permalink to this headline">#</a></h2>
<p>A powerful feature of Meep’s is the adjoint solver, which can be used to optimize the topology of components. Gmeep contains a function that takes in a GDSFactory component and returns a Meep optimization problem, which can then be run with another Gmeep function.</p>
<p><code class="docutils literal notranslate"><span class="pre">get_meep_adjoint_optimizer</span></code> is the first of these functions and it is the one that takes in a gdsfactory component. You must also specify the design region (which usually will overlay some part of the given component), the objective function specifying what you are actually optimizing for, and the design variables that you are initializing the design region to. An example is provided below showing more of the set-up.</p>
<p>After calling this function, <code class="docutils literal notranslate"><span class="pre">run_meep_adjoint_optimizer</span></code> is called to run the optimization with Meep. This function is where you specify, among other things, the bounds of optimization and what algorithm you are using for optimization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gdsfactory</span> <span class="k">as</span> <span class="nn">gf</span>
<span class="kn">import</span> <span class="nn">gdsfactory.simulation.gmeep</span> <span class="k">as</span> <span class="nn">gm</span>
<span class="kn">import</span> <span class="nn">meep</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">meep.adjoint</span> <span class="k">as</span> <span class="nn">mpa</span>
<span class="kn">import</span> <span class="nn">autograd.numpy</span> <span class="k">as</span> <span class="nn">npa</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">autograd</span> <span class="kn">import</span>  <span class="n">tensor_jacobian_product</span>
<span class="kn">from</span> <span class="nn">meep.adjoint</span> <span class="kn">import</span> <span class="n">get_conic_radius_from_eta_e</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">SiO2</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Medium</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mf">1.45</span><span class="p">)</span>
<span class="n">Si</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Medium</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mf">3.45</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">bend_circular</span><span class="p">()</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">extend_ports</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">design_region_width</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">design_region_height</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">eta_e</span> <span class="o">=</span> <span class="mf">0.55</span>
<span class="n">minimum_length</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">filter_radius</span> <span class="o">=</span> <span class="n">get_conic_radius_from_eta_e</span><span class="p">(</span><span class="n">minimum_length</span><span class="p">,</span> <span class="n">eta_e</span><span class="p">)</span>
<span class="n">eta_i</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">eta_d</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">eta_e</span>

<span class="n">resolution</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">design_region_resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">resolution</span><span class="p">)</span>

<span class="n">Nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">design_region_resolution</span> <span class="o">*</span> <span class="n">design_region_width</span><span class="p">)</span>
<span class="n">Ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">design_region_resolution</span> <span class="o">*</span> <span class="n">design_region_height</span><span class="p">)</span>

<span class="n">pml_size</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">waveguide_length</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">waveguide_width</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">Sx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pml_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">waveguide_length</span> <span class="o">+</span> <span class="n">design_region_width</span>
<span class="n">Sy</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pml_size</span> <span class="o">+</span> <span class="n">design_region_height</span> <span class="o">+</span> <span class="mf">0.5</span>
<span class="n">cell_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">Sx</span><span class="p">,</span> <span class="n">Sy</span><span class="p">)</span>

<span class="c1"># define the design region</span>
<span class="n">design_variables</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">MaterialGrid</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">Vector3</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">),</span> <span class="n">SiO2</span><span class="p">,</span> <span class="n">Si</span><span class="p">,</span> <span class="n">grid_type</span><span class="o">=</span><span class="s2">&quot;U_MEAN&quot;</span><span class="p">)</span>
<span class="n">design_region</span> <span class="o">=</span> <span class="n">mpa</span><span class="o">.</span><span class="n">DesignRegion</span><span class="p">(</span>
    <span class="n">design_variables</span><span class="p">,</span>
    <span class="n">volume</span><span class="o">=</span><span class="n">mp</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span>
        <span class="n">center</span><span class="o">=</span><span class="n">mp</span><span class="o">.</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">size</span><span class="o">=</span><span class="n">mp</span><span class="o">.</span><span class="n">Vector3</span><span class="p">(</span><span class="n">design_region_width</span><span class="p">,</span> <span class="n">design_region_height</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="c1"># filter</span>
    <span class="n">filtered_field</span> <span class="o">=</span> <span class="n">mpa</span><span class="o">.</span><span class="n">conic_filter</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">filter_radius</span><span class="p">,</span>
        <span class="n">design_region_width</span><span class="p">,</span>
        <span class="n">design_region_height</span><span class="p">,</span>
        <span class="n">design_region_resolution</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># projection</span>
    <span class="n">projected_field</span> <span class="o">=</span> <span class="n">mpa</span><span class="o">.</span><span class="n">tanh_projection</span><span class="p">(</span><span class="n">filtered_field</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>

    <span class="n">projected_field</span> <span class="o">=</span> <span class="p">(</span><span class="n">npa</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">projected_field</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">projected_field</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># interpolate to actual materials</span>
    <span class="k">return</span> <span class="n">projected_field</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>


<span class="n">seed</span> <span class="o">=</span> <span class="mi">240</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span>
        <span class="n">Nx</span> <span class="o">*</span> <span class="n">Ny</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">eta_i</span><span class="p">,</span>
    <span class="mi">128</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">J</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">):</span>
    <span class="n">power</span> <span class="o">=</span> <span class="n">npa</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">top</span> <span class="o">/</span> <span class="n">source</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">npa</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bottom</span> <span class="o">/</span> <span class="n">source</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">npa</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>

<span class="c1"># Use function to get optimization problem</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">get_meep_adjoint_optimizer</span><span class="p">(</span>
    <span class="n">c</span><span class="p">,</span>
    <span class="n">J</span><span class="p">,</span>
    <span class="p">[</span><span class="n">design_region</span><span class="p">],</span>
    <span class="p">[</span><span class="n">design_variables</span><span class="p">],</span>
    <span class="n">x0</span><span class="p">,</span>
    <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
    <span class="n">cell_size</span><span class="o">=</span><span class="p">(</span>
        <span class="n">Sx</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">design_region_width</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pml_size</span><span class="p">,</span>
        <span class="n">design_region_height</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pml_size</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">tpml</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">extend_ports_length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">port_margin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">port_source_offset</span><span class="o">=-</span><span class="mf">5.5</span><span class="p">,</span>
    <span class="n">port_monitor_offset</span><span class="o">=-</span><span class="mf">5.5</span><span class="p">,</span>
    <span class="n">wavelength_points</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">evaluation_history</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cur_iter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Objective function</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">gradient</span><span class="p">,</span> <span class="n">cur_beta</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current iteration: </span><span class="si">{</span><span class="n">cur_iter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">f0</span><span class="p">,</span> <span class="n">dJ_du</span> <span class="o">=</span> <span class="n">opt</span><span class="p">([</span><span class="n">mapping</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">eta_i</span><span class="p">,</span> <span class="n">cur_beta</span><span class="p">)])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">plot2D</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">plot_sources_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot_monitors_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot_boundaries_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">gradient</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">gradient</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">tensor_jacobian_product</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="mi">0</span><span class="p">)(</span>
            <span class="n">v</span><span class="p">,</span> <span class="n">eta_i</span><span class="p">,</span> <span class="n">cur_beta</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dJ_du</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">evaluation_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">f0</span><span class="p">)))</span>

    <span class="n">cur_iter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_iter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">f0</span><span class="p">)</span>

<span class="c1"># Define spatial arrays used to generate bit masks</span>
<span class="n">x_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">design_region_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">design_region_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">Nx</span><span class="p">)</span>
<span class="n">y_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">design_region_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">design_region_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span>
<span class="n">X_g</span><span class="p">,</span> <span class="n">Y_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_g</span><span class="p">,</span> <span class="n">y_g</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>

<span class="c1"># Define the core mask</span>
<span class="n">left_wg_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_g</span> <span class="o">==</span> <span class="o">-</span><span class="n">design_region_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Y_g</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">waveguide_width</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">top_wg_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_g</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">waveguide_width</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">design_region_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X_g</span> <span class="o">&gt;=</span> <span class="n">waveguide_width</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">design_region_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Y_g</span> <span class="o">==</span> <span class="n">design_region_height</span><span class="p">)</span>

<span class="n">Si_mask</span> <span class="o">=</span> <span class="n">left_wg_mask</span> <span class="o">|</span> <span class="n">top_wg_mask</span>

<span class="c1"># Define the cladding mask</span>
<span class="n">border_mask</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">X_g</span> <span class="o">==</span> <span class="o">-</span><span class="n">design_region_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="o">|</span> <span class="p">(</span><span class="n">X_g</span> <span class="o">==</span> <span class="n">design_region_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="o">|</span> <span class="p">(</span><span class="n">Y_g</span> <span class="o">==</span> <span class="o">-</span><span class="n">design_region_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="o">|</span> <span class="p">(</span><span class="n">Y_g</span> <span class="o">==</span> <span class="n">design_region_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">SiO2_mask</span> <span class="o">=</span> <span class="n">border_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">SiO2_mask</span><span class="p">[</span><span class="n">Si_mask</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">Nx</span> <span class="o">*</span> <span class="n">Ny</span>  <span class="c1"># number of parameters</span>

<span class="c1"># Initial guess</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span> <span class="o">*</span> <span class="mf">0.5</span>
<span class="n">x</span><span class="p">[</span><span class="n">Si_mask</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># set the edges of waveguides to silicon</span>
<span class="n">x</span><span class="p">[</span><span class="n">SiO2_mask</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># set the other edges to SiO2</span>

<span class="c1"># lower and upper bounds</span>
<span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nx</span> <span class="o">*</span> <span class="n">Ny</span><span class="p">,))</span>
<span class="n">lb</span><span class="p">[</span><span class="n">Si_mask</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nx</span> <span class="o">*</span> <span class="n">Ny</span><span class="p">,))</span>
<span class="n">ub</span><span class="p">[</span><span class="n">SiO2_mask</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">cur_beta</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">beta_scale</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">num_betas</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">update_factor</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">run_optimization</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">run_optimization</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">iters</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_betas</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;current beta: &quot;</span><span class="p">,</span> <span class="n">cur_beta</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iters</span> <span class="o">!=</span> <span class="n">num_betas</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">run_meep_adjoint_optimizer</span><span class="p">(</span>
                <span class="n">n</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">cur_beta</span><span class="p">),</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">lower_bound</span><span class="o">=</span><span class="n">lb</span><span class="p">,</span>
                <span class="n">upper_bound</span><span class="o">=</span><span class="n">ub</span><span class="p">,</span>
                <span class="n">maxeval</span><span class="o">=</span><span class="n">update_factor</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optimized_component</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">run_meep_adjoint_optimizer</span><span class="p">(</span>
                <span class="n">n</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">cur_beta</span><span class="p">),</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">lower_bound</span><span class="o">=</span><span class="n">lb</span><span class="p">,</span>
                <span class="n">upper_bound</span><span class="o">=</span><span class="n">ub</span><span class="p">,</span>
                <span class="n">maxeval</span><span class="o">=</span><span class="n">update_factor</span><span class="p">,</span>
                <span class="n">get_optimized_component</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
                <span class="n">threshold_offset_from_max</span><span class="o">=</span><span class="mf">0.09</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">cur_beta</span> <span class="o">=</span> <span class="n">cur_beta</span> <span class="o">*</span> <span class="n">beta_scale</span>

    <span class="n">optimized_component</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="n">final_figure_of_merit</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">evaluation_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/gds_to_meep_4_0.png" src="../_images/gds_to_meep_4_0.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./pages"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By CamachoLab and Google<br/>
  
      &copy; Copyright 2023.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>